# Synology Docker Compose Setup - Quick Reference

## ðŸ“¦ What Was Created

### 1. Production Docker Compose Configuration
**File**: `docker-compose.synology.yml`

**Services**:
- âœ… PostgreSQL 15 (Database) - Port 5433
- âœ… Redis 7 (Cache/Queue) - Port 6379
- âœ… FastAPI Backend (API) - Port 8000
- âœ… Next.js Frontend (UI) - Port 3000
- âœ… Celery Worker (Async tasks)
- âœ… Celery Beat (Scheduler)
- âœ… pgAdmin (DB Management) - Port 5050

**Key Features**:
- Separate networks for security (frontend_network, backend_network)
- Persistent Docker volumes for data storage
- Health checks for all services
- Automatic dependency management (backend waits for DB)
- Extensive inline documentation with interview Q&A

### 2. Environment Configuration Template
**File**: `.env.synology.example`

**Contains**:
- Database credentials
- Redis authentication
- JWT secret keys
- API URLs
- Port configurations
- Localization settings (Spanish/English)

### 3. Automated Setup Script
**File**: `scripts/setup-synology.sh`

**Features**:
- âœ… Validates prerequisites (Docker, directories)
- âœ… Creates required directories with proper permissions
- âœ… Generates secure passwords automatically
- âœ… Creates `.env` file with generated credentials
- âœ… Validates Docker Compose syntax
- âœ… Provides step-by-step instructions

### 4. Comprehensive Documentation
**Files**: 
- `docs/SYNOLOGY_DEPLOYMENT_GUIDE.md` - Complete deployment guide
- `docs/SYNOLOGY_README.md` - Quick reference

**Includes**:
- Installation steps
- Security hardening
- Monitoring & maintenance
- Troubleshooting
- Backup strategies
- CI/CD integration

## ðŸ—ï¸ Directory Structure

```
Synology NAS:

/volume1/docker/bitcorp/          â† Docker Compose runtime location
â”œâ”€â”€ docker-compose.yml            (copy from docker-compose.synology.yml)
â”œâ”€â”€ .env                          (copy from .env.synology.example)
â””â”€â”€ CREDENTIALS.txt              (generated by setup script)

/volume1/PeruFamilyDocs/BitCorp/bitcorp/  â† Codebase location
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ logs/                    (created by setup script)
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ database/
â”‚   â””â”€â”€ backups/                 (created by setup script)
â”œâ”€â”€ docker-compose.synology.yml  (source file)
â”œâ”€â”€ .env.synology.example        (template)
â””â”€â”€ scripts/
    â””â”€â”€ setup-synology.sh        (setup script)
```

## ðŸš€ Deployment Methods

### Method 1: Automated (Recommended)
```bash
# SSH into Synology
ssh admin@your-synology-ip

# Run setup script
cd /volume1/PeruFamilyDocs/BitCorp/bitcorp
sudo bash scripts/setup-synology.sh

# Follow on-screen instructions
```

### Method 2: Manual
```bash
# 1. Create runtime directory
sudo mkdir -p /volume1/docker/bitcorp

# 2. Copy files
sudo cp /volume1/PeruFamilyDocs/BitCorp/bitcorp/docker-compose.synology.yml \
        /volume1/docker/bitcorp/docker-compose.yml

sudo cp /volume1/PeruFamilyDocs/BitCorp/bitcorp/.env.synology.example \
        /volume1/docker/bitcorp/.env

# 3. Edit environment
sudo nano /volume1/docker/bitcorp/.env
# Update passwords, SECRET_KEY, NEXT_PUBLIC_API_URL

# 4. Create directories
sudo mkdir -p /volume1/PeruFamilyDocs/BitCorp/bitcorp/backend/logs
sudo mkdir -p /volume1/PeruFamilyDocs/BitCorp/bitcorp/database/backups
sudo chown -R 1000:1000 /volume1/PeruFamilyDocs/BitCorp/bitcorp/backend/logs
sudo chown -R 1000:1000 /volume1/PeruFamilyDocs/BitCorp/bitcorp/database/backups

# 5. Deploy
cd /volume1/docker/bitcorp
sudo docker-compose up -d

# 6. Initialize database
sudo docker-compose exec backend alembic upgrade head
```

## ðŸ” Security Checklist

- [ ] Change all default passwords in `.env`
- [ ] Generate secure SECRET_KEY: `openssl rand -hex 64`
- [ ] Update NEXT_PUBLIC_API_URL with your Synology IP
- [ ] Configure firewall rules (ports 3000, 8000, 5433, 6379, 5050)
- [ ] Disable pgAdmin in production (comment out in docker-compose.yml)
- [ ] Restrict PostgreSQL/Redis to localhost only
- [ ] Enable HTTPS via Synology reverse proxy
- [ ] Set up Let's Encrypt certificate
- [ ] Update CORS settings in `backend/app/core/config.py`
- [ ] Delete CREDENTIALS.txt after storing passwords
- [ ] Set proper file permissions: `chmod 600 .env`

## ðŸ“Š Essential Commands

### Deployment
```bash
cd /volume1/docker/bitcorp

# Pull images
sudo docker-compose pull

# Build custom images
sudo docker-compose build --no-cache

# Start all services
sudo docker-compose up -d

# Monitor startup
sudo docker-compose logs -f
```

### Monitoring
```bash
# Check status
sudo docker-compose ps

# View logs
sudo docker-compose logs -f backend

# Resource usage
sudo docker stats

# Health checks
curl http://localhost:8000/health
curl http://localhost:3000
```

### Maintenance
```bash
# Restart services
sudo docker-compose restart

# Stop all
sudo docker-compose stop

# Update application
sudo docker-compose build --no-cache
sudo docker-compose up -d

# Backup database
sudo docker-compose exec db pg_dump -U bitcorp bitcorp_erp | gzip > backup.sql.gz

# Restore database
gunzip < backup.sql.gz | sudo docker-compose exec -T db psql -U bitcorp bitcorp_erp
```

## ðŸŒ Access Points

After deployment, access via:

- **Frontend**: http://your-synology-ip:3000
- **Backend API**: http://your-synology-ip:8000
- **API Docs**: http://your-synology-ip:8000/docs
- **pgAdmin**: http://your-synology-ip:5050

**Test Credentials**:
- Operator: `john.operator` / `operator123`
- Admin: Check `scripts/seed_data.py`

## ðŸ› Common Issues

### Port Conflicts
```bash
# Check what's using a port
sudo netstat -tulpn | grep :8000

# Change port in .env
BACKEND_PORT=8001
```

### Permission Errors
```bash
# Fix permissions
sudo chown -R 1000:1000 /volume1/PeruFamilyDocs/BitCorp/bitcorp/backend/logs
sudo chmod -R 755 /volume1/PeruFamilyDocs/BitCorp/bitcorp/backend/logs
```

### Database Connection Failed
```bash
# Check database health
sudo docker-compose ps db

# Test connection
sudo docker-compose exec db psql -U bitcorp -d bitcorp_erp
```

### Container Won't Start
```bash
# View logs
sudo docker-compose logs backend

# Validate config
sudo docker-compose config
```

## ðŸ“š Documentation

- **Complete Guide**: `docs/SYNOLOGY_DEPLOYMENT_GUIDE.md`
- **File Overview**: `docs/SYNOLOGY_README.md`
- **Docker Compose**: Inline comments in `docker-compose.synology.yml`
- **Environment Vars**: Comments in `.env.synology.example`

## ðŸŽ“ Learning Resources

All deployment files include extensive educational comments covering:
- Architecture decisions and trade-offs
- Performance optimization techniques
- Security best practices
- Interview preparation Q&A
- Book references (Clean Code, API Design, etc.)

## ðŸ”— Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Internet / Local Network        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Ports: 3000, 8000, 5050
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Synology Firewall    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Docker Networks      â”‚
    â”‚                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ frontend_networkâ”‚  â”‚
    â”‚  â”‚   - Frontend    â”‚  â”‚
    â”‚  â”‚   - Backend     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ backend_network â”‚  â”‚
    â”‚  â”‚   - Backend     â”‚  â”‚
    â”‚  â”‚   - PostgreSQL  â”‚  â”‚
    â”‚  â”‚   - Redis       â”‚  â”‚
    â”‚  â”‚   - Celery      â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Benefits**:
- Frontend can't directly access database or Redis
- Backend acts as API gateway
- Database/Redis accessible only from backend containers

## ðŸ”„ Backup Strategy

### Automated Daily Backup
Use Synology Task Scheduler:

```bash
#!/bin/bash
BACKUP_DIR="/volume1/PeruFamilyDocs/BitCorp/bitcorp/database/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
docker exec bitcorp_postgres pg_dump -U bitcorp bitcorp_erp | gzip > "$BACKUP_DIR/backup_$TIMESTAMP.sql.gz"
find "$BACKUP_DIR" -name "backup_*.sql.gz" -mtime +30 -delete
```

Schedule: Daily at 2:00 AM

### Docker Volumes
Use Synology Hyper Backup to backup:
- `/volume1/@docker/volumes/bitcorp_postgres_data/`
- `/volume1/@docker/volumes/bitcorp_backend_uploads/`

## ðŸŽ¯ Next Steps

1. âœ… Deploy using automated setup script
2. âœ… Access frontend at http://your-ip:3000
3. âœ… Test API at http://your-ip:8000/docs
4. âœ… Configure reverse proxy for HTTPS
5. âœ… Set up automated backups
6. âœ… Configure firewall rules
7. âœ… Update CORS settings for production
8. âœ… Disable pgAdmin
9. âœ… Monitor resource usage
10. âœ… Test backup/restore procedures

## ðŸ“ž Support

- **Documentation**: Full guide in `docs/SYNOLOGY_DEPLOYMENT_GUIDE.md`
- **Logs**: `sudo docker-compose logs -f`
- **Validation**: `sudo docker-compose config`
- **GitHub**: Report issues with logs and system info

---

**Created**: January 2025  
**Version**: 1.0.0  
**Maintainer**: asjadaugust
